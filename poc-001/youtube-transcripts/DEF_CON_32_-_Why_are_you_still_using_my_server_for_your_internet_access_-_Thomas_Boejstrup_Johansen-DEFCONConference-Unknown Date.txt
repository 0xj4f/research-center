yeah my name is Thomas and um my daily work is incident response and forensics uh I had done some red team so in red team engagements I often use responder where there's a function to set up a rogue proxy server with the double vpad function so monitoring the network to see the traffic seeing that clients is asking for the vpad domain uh in the company but it is also sometimes asking for vpad dold so who is having this domain is it in use is it free can I buy it what are they using it for so at the time I looked at this I looked up and discovered it was a German guy that had this Danish domain uh don't know what he was using it for two years later I looked again discovered this summon in Israel having the Danish domain and in 2020 the Danish register for Deco DK domains added at a function where you can sign up for a waiting list so I signed up for a waiting list and paid small fee every year so how it's working the basic is that a client goes to for requesting a web page it's going to the DNS server finding the IP address then go to the web server and and getting the content back very basic if we are adding a proxy server into the mix then the proxy server will do all the heavy lifting so the client is asking the proxy server the proxy server is is doing the name resolving and getting the web page and returning the content to the end client so back in 1996 scape decided that there must be an easier function for when you're adding a machine to a network to automatically config the machine so they come up with this uh double vpad function to automatic ask for the machine where the configuration file is stored um they sit down a Consortium to try to make a fc standard for it but it never eclipsed so it expired in 19 99 so it's 25 years uh anniversary now according to Wikipedia the way it works is that you have the name where the client is uh part of the domain it will add V in the front and slowly test until it finds a a name where it matches and get a response and can download the configuration file but in some implementations it will go down down to vpad dold and then download the configuration file from there and as you can see on the Wikipedia page here it says that it a incorrect uh solution and it shouldn't be used that way so that's a security issue so the way with repad is that you have a client it's called client. a. company.com then it will search for vpad when the browser is opened it will then remove the client name and then try to add vp. a. company.com and try to resolve that if that's not working it removes one name so it's vp. company.com and in this example it's resolving the IP address and then it goes to a web server trying to download a file called vpad DOD and that's the configuration file for the client it can also be config with other solution like DHCP vins and so on so the that file it downloads is actually a small JavaScript that the client execute on the client machine with uh called find proxy for URL it's input what URL is trying to go to and the name and then you can modify this script to say that the client should go direct if it's company name addresses or it should go to a proxy server if it's all anything else on the internet like this proxy company. t.8 ad0 so here we have an example of where try and go to defc con.org and it's not matching any of the if statements and then go to the proxy as the last return statement there's a website dedicated for all the functions that can be used in this limited very limited uh JavaScript language you cannot use all functions um here you can see the top part of the functions that DNS domains resolve is it in net and so on but there's also some other functions do work like I have found here the stable functions I call them with I can get user agent host name time zone and so on in the past I could also from some clients get screen resolution and color depth and and so on from each client but that's very unstable and many of the clients that crashes the JavaScript when trying to ask for that so remov that so when a vpad is implemented is not implemented in a company and someone gets the top level domain then what happen is that the client is asking for the vpad in the company it doesn't get any results it tries Again by removing one name and tries Again by removing one name and ending on vpad DK so it goes to a external vpad web server downloading a configuration file for the client how it should use proxy settings and trust that server even as it's not inside the company in 1999 when it expired and Microsoft was part of this Consortium the same month Microsoft was informed that uh there's a security issue if someone buys this top level domain in TL with any TLD you can basically own a complete country so there has been talks about this before in 2007 on kicon there was some guy having a 8year anniversary for this issue looking at the things and had a very good talk unfortunately it's not public anymore and then a smooth comom same year another guy had the look into this and then Microsoft got busy again trying to make a new patch trying to fix whatever that was found in 2007 so now it's fixed right it should be so for me the waiting time is over in 20123 in March I got a mail from the Danish register Deco host Master saying that the vp. DK domain was now mine and I could register it and assign it to a server so I found a cheap V and added to a a web server there just because of thinking I want to see if there's any traffic at all uh just monitor the locks and so on at the same time I looked at the who has owned this domain in the past and I could see that from the talks in 2007 there was someone in Denmark deciding it was a good idea to have this domain for some years but then he sold it and one guy in Belgium got the domain and one in Germany and then one in Israel and then I got it here last year so this is the locks from the first day I assigned the vpad to a web Hotel I was a bit surprised to get more than 880,000 requests of this vad do that file on the first day basically the spike in the graph I think that's the roll over time from I started I has to go 24 hours that's why it's not linear so basically 85 request on the first day without doing anything other than buying a BB hotel and adding the domain so that's not fun because I don't have access to all the lock files so the way was that I set up a VPS server installed DNS server on it become my own uh name server on the internet registered and DNS SEC and all the things and added a VB server on top of that that way I could add the domains I got into this server and capture all the traffic all the locks in the way I like to have them and every good website should have a web page right so I took my best skills and open notepad and crafted a web page where I added some crap about shouldn't use this page and uh this is for research and so on so when the client is downloading this vpad that file the JavaScript and executing it on the internal client machine it cannot see the public IP that is coming out on when it's going onto the internet so the way I fixed that was that I added on my web server at a dynamic web page that builds the jascripts for the client dynamically so I add the client's public IP into the script before each client get the script so they're getting a dedicated script for each client so I have the public IP even the client doesn't know it in the in by them themselves on the internal n work so when a client one two three want to go to uh the net this is a simplified version of my scripts but what is basically doing I'm building a string in the DNS name with the information I take from the client like the time zone internal IP external IP and so on so it I can leak data to my DNS server uh about the internal client so in this example you can see the client is told to go to defc con.org and the D is the time zone I and then internal IP W is the world IP public IP and then it goes to p.v pad. DK as my server and of course I use port 80 because I want all the traffic to me unencrypted so just come as normal HTTP un encrypted so the then the Cent for every request they make on the machine all urls they will pass it through this web par scripts and then it will go to this address that built automatically or dynamically for each request they're doing so I get in my log files um listing of what traffic they are trying to resolve and then I tell them to all the request go to this web server there is my web server on the same host and then the client is asking my server for some web page and I and I'm so kind so I return errors for everything because I don't want to run a proxy server on the internet that is opened and be man in the middle so I just return errors for everything and yes I get the see the inside with his ggp clear text but they think I'm asking on the outside at hgbs so for every request every every client is making are returning this error page um and to be nice to the users I have included a input form so if they don't like what they're seeing they can tell me what the hell is wrong and what I should do better and there's also a checkbox for whitelisting the client so they can input their client the host name and add the click the whitelist checkbox but I haven't implemented that function so this is first step on the form right yeah and just a disclaimer I'm not intercepting any traffic I'm just looking at lock files and so on from request that's coming in I haven't told any clients anywhere to contact my server I only just bought one domain name set up a web server and all the clients is coming to my server so this is example of information I'm getting from one client I can see the client's public IP what name server used what internal IP address it has the time zone and then from of course from the web server lock I can see what they're asking for and thereby also what which user agent string they have what application are they using and operating system and so on so this was fun that come get a lot of traffic into the server um more than I expected so why not look for buying some more domains um sadly the three domains here they are reg protected so you cannot register them there's a limit on that they have already set that up but I got ID ins side and build just for fun and why not looking at the list there was press and porn so we can try see which one of them is the most popular one and because we are here do Vegas and then I found that the vp. was apparently registrated but there was someone trying to sell the domain but I'm not buying it at that price so I could see that also rented domain so I asked them can I rent this domain for one year and is there any limits or rules for what I can use the domain for and they say no you can there's no rules you can rent it for one year and I paid three and A2 EUR per month for renting the domain and then I probably lightly return it when I was done with it so this is my list of of domains for This research and for one year from April to April I get 1.1 billion DNS requests with solving in 200 GB Tex loock files this is for the DNS server alone and if you look down on the I don't know how big it is but there's a client asking for cnn.com and you can then see the the internal IP and public IP and so on of the clients so here I have seen on which vad domain where are the clients coming from in the world and for the Danish domain. DK there's obviously a lot of traffic from Denmark but to my surprise why is there so much traffic from Russia and Ukraine to the Danish domain and then there's a big jump down to Germany so it's a bit odd there's so much traffic for the for that on the DK domain and the do Vegas domain on the right yeah of course United States will be there but all the other domains it's a mixed order why they have the Vegas so when Windows machines today is connected to a network it will in the lower right corner s tray have a nice icon indicating it has internet access and and is working but in because I'm a proxy server that doesn't return anything and doesn't work by Design the clients of course will show that they don't have internet access so I found that for this list of six Microsoft domains if I return the string okay for every request the client will indicate this has good internet access so I just added a rule to the proxy web server function saying if you see this domain respond with okay and all the clients then suddenly indicated they have good internet access again so what type of traffic do I see here's the types of request I see and again of course I will see a lot of uh get requests but I also see a lot of post requests so that's client sending data up to the servers and then I got all the connect request that's the proxy traffic there's 1.1 billion request for asking the proxy server to collect something so that's actually clients that has download the Y proxy P scripts and executed on the machine and then coming and asking for Vib page but also we see on the list there's vipto there's Apple there's uh s Microsoft SSM client there's Microsoft VPN and there's many more I have not included in this so there's a lot of different surfect in in this and that is based on the Apache lock files you can see in the lower corner about 470 gab Apache lock files with 1.5 billion requests in them so it takes some times to grab through them and find the data so because I am a proxy server the client trusts and I have given them a configuration scripts I have told them to send every data to my server including local traffic so if you look here you can see an internal client as 1.5 it should actually talk to the same computer on the same network next to it 1.1 but because I've given it descript saying no you should ask the proxy server it's sending the traffic up to me and asking me as a prox server even that they are on the same network and post requests this is clients sending data they're just posting data against a web server um 37 million requests as I don't have the data I only have the logs I don't know what it is but it everything client sends to servers so there could be confidential data whatever documents files content whatever and again because I'm controlling everything with my proxy scripts so every local traffic I have in the domain L from the clients it should never go to the Internet because it's not resolvable on the internet that's designed to be handled to be used for internal Network so here we see some funny domains like catrix and file print and V Center and yeah where the client is coming up to my proxy server and ask asking for me to get that traffic because it's local I can of course not get the traffic but I can see what they are asking for and then some years back there started to be a new smart function in the browsers because they want to protect the DNS traffic saying we want now to send the DNS traffic over https because then Rogue guys man in the middle couldn't happen and they better couldn't control it but because I'm now a man in the middle proxy server I'm also controlling the DNS or htttp and it's basically just as you can see here a client asking for bu.com and then it returns a Json blob so my proxy could return whatever I want a Json blob directing the client to go to another location or whatever so passing through the lock files and looking for all the file extensions that is downloaded this is some of them this the highlighted one uh it's a bit scary to see all the credentials and certificates and there's the executables there's database files there's scripts so I could replace a script and if the client is executing the script on the machine it's not a good thing for the client here's example of executable files the clients try to download so there's some Windows update Microsoft installer there's antivirus updates Microsoft secm client and Real Player and didn't know Real Player still was a thing but okay so there's a lot of different uh requests here and I get a lot of them this is just a small sample list but the list of file names I found with the extensions is not fully true because I also found that there was some bad guys trapped in my setup trying to scan other servers so they were trying to enumerate for different files like pfx files and other files so you can see here there's a long list where they try to access a web server asking for different files and hoping that they find something so credentials in the URL there's a lot of them get 200 100,000 URL requests with where the username and password is part of the URL and and I don't know if you can see the size of the screenshot there but it's apparently a Indian guy that has a lot of friends he is using a web service to send SMS uh messages to all his friends he apparently have a lot of friends there was many many lock lines here so they all start with deer something um yeah I don't know what he is trying to do so credentials here's some of the clear text non-encrypted credentials I just get to the server and I have some of them is so ridiculous like admin admin I can cannot censor that away it you should see it and there change me change me I think that's a good idea to change that one um and security party yeah we are defon security is a party so yeah that's very crappy credentials and NM ver version one shouldn't be used for the last 20 years as Microsoft has tried to tell us change to nlm version two so administrator rout security accounts and so on with NM version one and then there's nlm version two I also got many many clients sending the credentials and there's some good usernames admin administrator doctor Hotel manager and then a laser that sounds fun to play with um an sa that's normally a system ADR account on SQL servers and likes so many good credentials if you are malicious so what is the client talking to this server when I started this project my my thinking was this is just Microsoft crap and they should patch the things but if you look at the list you can see it's basically everything every application it's VPN CLI it's antivirus applications it's uh yeah the list is very long this is just some of them there's Cobalt strike and you can see in the lower right left corner there's even some guy having trouble with his internet access so he's using wi shark to debug his network is not working because he's apparently using a proxy that doesn't return anything so he's debugging that and I then get his uh update check from wire shark yeah so the list is long that's Pon Vin and many clients in fact I got 27,000 different user agent strings with Linux Mac iPhone Android whatever all platforms so now I cannot say which client it is that has the issue and which application that has the issue because it seems to be everything oh yeah so when you're running an a proxy server that doesn't return anything and you have clients behind it there was some of the clients was not able to download some um updated um background screen that the crow provided to Windows machines so I have actually protected 226 machines from [Applause] Cross and about what about detection the only place I have seen any detection is when clients is behind a paloalto setup the palto setup will monitor the URLs the clients is asking for and then try to categorize them and check them from elicious thing and so on like many other proxy servers is also doing it's the only one I have seen in the traffic that's interacting with the traffic and the way it's doing it is replaying the same request that the user tried to do but it asking adding this user agent string this long string you see here that's the complete string so it's a pretty long user agent string where it says it's PTO monitoring device and so on and it's suggesting I can send a mail to them to get WID listed but again I'm a proxy server and I'm not the destination so it will pretty many males I have to send to them to get WID listed for everything so I haven't tried that and then Cisco apparently has some kind of uh endpoint client you can install on computers and I it's my understanding it is designed to protect the client from Rogue DNS servers and Rogue proxy servers um it's not working so well because what happened is because I'm returning Arrow pages to everything and rejecting all traffic the client in and the client machine the application seems to get angry and just making Brute Force against my machine trying to Loop and getting the request again and again again again and trying so the only way was I had to make a black hole for the domain so I just discarded everything with open dns.com into to a null and didn't reply on it and then the Cisco client stopped dsing my server yeah so I have also found what I think is malicious this is uh for the domains engineer exchange Expos software and so on there a vpad script and it seems to be uh running a proxy for HTTP and FTP traffic with the fail option so if it doesn't work it will go direct but it's also collecting data and sending it over an extra Channel with some communication so this looks like someone is monitoring traffic for this uh four domains here and this this one is a bit weird one um it's a I think it's other is a guide that really really like ads or it's it's just some testing going on because on vp. trade there's a proxy script there's looking with a lot of if statements if there's including some kind of add word in the request it will send the request through a proxy server if there's not a word then it will go direct so it seems that someone is trying to collect all the ads the reason for this I think can maybe be that he is replacing the ad IDs in the traffic to his own and by this earning money on capturing the traffic and then getting paid because he's directing all the clients to his ad ID maybe or it's a test for something or he just like ads I don't know so here's another one also a bit weird and the name the clds that doesn't Mr cooking storage surf there's no no uh continuous line in them um it claims to be some sort of security project I haven't been able to found or find any place where they are talking about this project and anything so it's only a claim inside this configuration file it's it's a bit weird in it's only sending the traffic to a proxy server for what is not result of the domains so all the things that failed it sends to the proxy server anything else it goes to direct so it's maybe something that tries to look for all the odd things that's hidden on the net I don't know what the function is yeah so we have a winner apparently press is more interesting than porn I wouldn't have guessed otherwise but uh this is the score for the V that file how many times it downloaded and they have been running at the same server same time for the same so from the client from the forms I get with the users I got 40 users that click that wanted wh listing from this error even I haven't implemented any function to wh list anything and just returning errors to them and they insert some computer names it does doesn't look like DNS names but it's computer names so yeah maybe a day I will add a whit list function and here we have some feedback from the users apparently they are not all happy some users say I got this error message when trying to get to my netbank or I clicked this link in the mail and got this arror or t-shirt or whatever so not all users are happy so when I saw that I was getting feedback from the users so thinking why not set up a survey asking the user how much they like my non nonworking proxy server that only return errors to all the clients so I added this uh three normal steps that could ask and to my surprise I have a higher leaning on they really like my service and would recommend it to their friends so this is for non-working proxy but there was only four responses so yeah and there was no one submitting EMA email address so the $100 it going to disis cancer font I added uh on the on the web page I added a feedback form maybe getting some good suggestions and so on to what I can improve on my non-working proxy but uh I only got more than 3,000 spam messages saying that they will uh Is AO optimize my website so mob will find it I don't know if I should sign up for that I have many clients already um and zero feedback from anyone so for the period of this one year I monitored via by Google if anyone anywhere was writing about this domain I had on my list to see if they was talking about it in some Forum talking about disabling vpad and so on um I haven't found anyone for one year talking about anything about the domains so it has been to my knowledge completely silent for one year without any detection anywhere so my question is why can a dude like me even buy this domain why should this crap as 25 years old not be just disabled why do we have this it's not it's not modern security model we just download a a park script with a JavaScript run it on the client and then the client just sends all the traffic to a proxy server it's not very secure so I don't know if I can stand here in 25 years or in a wheelchair talking about the same thing once again saying that nothing have changed I don't know but it is 25 year anniversary yeah I can see I have still some time so first of all a big shout out to my friend kill Norman for a lot of help with the research and and information and I have some bonus slides because I have some extra time so I posted this uh this talk was on the schedule pce on Defcon and shortly after that time I was contacted by a guy that's called ton saying that uh he was for the last half year basically doing the same Research into some other domain names and we could look and share some data that could be fun if we had the time um but also he's had paid up for some domains in the 80 and from what I've I heard there should be a coming a really really good talk I look forward to hear how many a active directories there uh coming in the same way okay 10 minutes so after running this for basically two months I got contacted in Denmark Denmark is not a very big place about five six million people so the security Community is not that big I got contacted from someone saying Thomas is you're running some kind of research project for the vpad yeah okay this big company apparently got a lot of machine trapped in the vpad de file and all the traffic was going to my server so they they just wanted to know and the way they found it was because uh one of the domains I had on my list it was not fully uh anonymized so they could see the name Thomas and then say ah Thomas from Denmark then we we try to call him that's good research yeah so if you're looking back on 27,000 different user agent strings on basically all platforms I would like to present one slide saying this is Microsoft crap here's the three settings you want to set on a Microsoft machine and you're protected but this seems to be all platforms all applications that has the issue otherwise I wouldn't have got so much traffic as I've seen in my data so my best advice is to add into the host file on the machine uh the vpad domains and saying that is a loop back to itself so it will never send any traffic to the internet and then you have to look up uh each OS see which way you can disable the function on there and also add the vpad to your company domain so if a client is asking on that domain it will not uh uh resolve other than 127 a thing also to note here that I skipped over is that when a client download my vpad configuration config file it CES the file so when people are working from home they maybe on a network where they can download the file in a in a DK domain they download the file start using the proxy get into the workplace keep doing using the proxy because they're cing the fire I told them to use this file for 14 days or something so they will keep using it um yeah and it's best to disable this vpad function at system level otherwise it you will if you only disa in that browser all the services you have on your machine that running at system they are also talking like antivirus application they are talking to the internet that will not inherit in configuration from the client settings so it's best to set it on Machine level so it's everything on the machine and disable its function and as you can see there's a Windows service called htttp Windows proxy automatic Discovery service it's on all machines no one know what it is but now you KN know what it is it can be difficult to disable because it has dependency to other things um yeah so basically read the manual to find out how to disable it on all application and os's because it's not easy to for me to make one slide that fix it at all yeah so this is the slides again thank you to kill [Applause]